"use strict";var C=Object.defineProperty,L=Object.defineProperties;var W=Object.getOwnPropertyDescriptors;var T=Object.getOwnPropertySymbols;var G=Object.prototype.hasOwnProperty,I=Object.prototype.propertyIsEnumerable;var O=(e,t,o)=>t in e?C(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o,D=(e,t)=>{for(var o in t||(t={}))G.call(t,o)&&O(e,o,t[o]);if(T)for(var o of T(t))I.call(t,o)&&O(e,o,t[o]);return e},F=(e,t)=>L(e,W(t));var B=(e,t,o)=>(O(e,typeof t!="symbol"?t+"":t,o),o);var x=(e,t,o)=>new Promise((r,i)=>{var l=s=>{try{a(o.next(s))}catch(u){i(u)}},n=s=>{try{a(o.throw(s))}catch(u){i(u)}},a=s=>s.done?r(s.value):Promise.resolve(s.value).then(l,n);a((o=o.apply(e,t)).next())});Object.defineProperties(exports,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}});const N=require("fs/promises");function J(e){var t=e.default;if(typeof t=="function"){var o=function(){return t.apply(this,arguments)};o.prototype=t.prototype}else o={};return Object.defineProperty(o,"__esModule",{value:!0}),Object.keys(e).forEach(function(r){var i=Object.getOwnPropertyDescriptor(e,r);Object.defineProperty(o,r,i.get?i:{enumerable:!0,get:function(){return e[r]}})}),o}var c={};const z={},H=Object.freeze(Object.defineProperty({__proto__:null,default:z},Symbol.toStringTag,{value:"Module"})),q=J(H);Object.defineProperty(c,"__esModule",{value:!0});c.promisifyChildProcess=R;c.spawn=V;c.fork=Z;c.execFile=c.exec=void 0;const k=q,j=e=>t=>e.then(o=>x(exports,null,function*(){return yield t(),o}),o=>x(exports,null,function*(){throw yield t(),o}));function P(e,t){if(e[0]instanceof Buffer){const o=Buffer.concat(e);return t?o.toString(t):o}return e.join("")}function R(e,t={}){const o=new Promise((r,i)=>{const{encoding:l,killSignal:n}=t,a=l!=null||t.maxBuffer!=null,s=t.maxBuffer!=null?t.maxBuffer:200*1024;let u,y=0;const S=[],_=[],b=f=>p=>{const m=Math.max(0,s-y),w=Buffer.byteLength(p,"utf8");y+=Math.min(m,w),w>m&&(u=new Error("maxBuffer size exceeded"),e.kill(n||"SIGTERM"),p=p.slice(0,m)),f.push(p)};a&&(e.stdout&&e.stdout.on("data",b(S)),e.stderr&&e.stderr.on("data",b(_))),e.on("error",i);function M(f,p){u||(f!=null&&f!==0?u=new Error(`Process exited with code ${f}`):p!=null&&(u=new Error(`Process was killed with ${p}`)));function m(d){if(d.code=f,d.signal=p,a)d.stdout=P(S,l),d.stderr=P(_,l);else{const Y=U=>({configurable:!0,enumerable:!0,get(){return console.error(new Error(`To get ${U} from a spawned or forked process, set the \`encoding\` or \`maxBuffer\` option`).stack.replace(/^Error/,"Warning")),null}});Object.defineProperties(d,{stdout:Y("stdout"),stderr:Y("stderr")})}}const w=u;if(w)m(w),i(w);else{const d={};m(d),r(d)}}e.on("close",M)});return Object.create(e,{then:{value:o.then.bind(o)},catch:{value:o.catch.bind(o)},finally:{value:j(o)}})}function V(e,t,o){return R(k.spawn(e,t,o),Array.isArray(t)?o:t)}function Z(e,t,o){return R(k.fork(e,t,o),Array.isArray(t)?o:t)}function A(e){return(...t)=>{let o;const r=new Promise((i,l)=>{o=e(...t,(n,a,s)=>{n?(n.stdout=a,n.stderr=s,l(n)):i({code:0,signal:null,stdout:a,stderr:s})})});if(!o)throw new Error("unexpected error: child has not been initialized");return Object.create(o,{then:{value:r.then.bind(r)},catch:{value:r.catch.bind(r)},finally:{value:j(r)}})}}const K=A(k.exec);c.exec=K;const Q=A(k.execFile);c.execFile=Q;const X=c.exec;c.execFile;c.spawn;c.fork;var h=class extends Error{constructor(e){super(e),this.name="Logover",this.stackTraceDepth=2}get stacks(){if(this.stack){let e=this.stack.split(`
`);return[e[0],...e.slice(2,this.stackTraceDepth+2)].join(`
`)}return""}set stackDepth(e){this.stackTraceDepth=e}},ee=(e=>(e.Black="0m",e.Red="1m",e.Green="2m",e.Yellow="3m",e.Blue="4m",e.Magenta="5m",e.Cyan="6m",e.White="7m",e))(ee||{}),te=(e=>(e.Reset="\x1B[0m",e.Bright="\x1B[1m",e.Dim="\x1B[2m",e.Italic="\x1B[3m",e.Underline="\x1B[4m",e.Blink="\x1B[5m",e.FastBlink="\x1B[6m",e.Reverse="\x1B[7m",e.Hide="\x1B[8m",e.Strike="\x1B[9m",e.Foreground="\x1B[3",e.Background="\x1B[4",e))(te||{}),g={debug:0,info:1,warn:2,error:3},oe=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],re=["January","February","March","April","May","June","July","August","September","October","November","December"],ne=["Mon","Tue","Wed","Thu","Fri","Sat","Sun"],se=["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"];function E(e,t){if(e===null)return"";if(typeof e=="string")return $(new Date,e);let o=e[t];if(o===void 0)return"";if(o)return $(new Date,o);throw new h(`Invalid timestamp format. See https://github.com/ShaunSHamilton/logover for configuration options.
`)}function $(e,t){let o=e.getFullYear().toString(),r=o.slice(-2),i=e.getMonth(),l=oe[i],n=(i+1).toString().padStart(2,"0"),a=re[i],s=e.getDay(),u=ne[s],y=se[s],S=e.getDate().toString().padStart(2,"0"),_=e.getHours().toString().padStart(2,"0"),b=e.getMinutes().toString().padStart(2,"0"),M=e.getSeconds().toString().padStart(2,"0"),f=e.getMilliseconds().toString().padStart(3,"0"),p=e.getTimezoneOffset()>0?"-":"+";return t.replace(new RegExp("(?<!\\\\)Y(?<!\\\\)Y(?<!\\\\)Y(?<!\\\\)Y","g"),o).replace(new RegExp("(?<!\\\\)Y(?<!\\\\)Y","g"),r).replace(new RegExp("(?<!\\\\)M(?<!\\\\)M(?<!\\\\)M","g"),l).replace(new RegExp("(?<!\\\\)M(?<!\\\\)M","g"),n).replace(new RegExp("(?<!\\\\)M","g"),a).replace(new RegExp("(?<!\\\\)W(?<!\\\\)w(?<!\\\\)w","g"),u).replace(new RegExp("(?<!\\\\)W","g"),y).replace(new RegExp("(?<!\\\\)d(?<!\\\\)d","g"),S).replace(new RegExp("(?<!\\\\)h(?<!\\\\)h","g"),_).replace(new RegExp("(?<!\\\\)m(?<!\\\\)m","g"),b).replace(new RegExp("(?<!\\\\)s(?<!\\\\)s","g"),M).replace(new RegExp("(?<!\\\\)S(?<!\\\\)S(?<!\\\\)S","g"),f).replace(new RegExp("(?<!\\\\)Z","g"),p)}var ie=class{constructor(e){this.options={level:"info",info:"\u{1F535} INFO: ",warn:"\u{1F7E0} WARN: ",error:"\u{1F534} ERROR: ",debug:"\u{1F7E2} DEBUG: ",trace:[],stackTraceDepth:2,timestamp:{debug:"YYYY-MM-dd hh:mm:ss",info:"YYYY-MM-dd hh:mm:ss",warn:"YYYY-MM-dd hh:mm:ss",error:"YYYY-MM-dd hh:mm:ss"}},e&&Object.keys(e).map(t=>{if(!this.options.hasOwnProperty(t))throw new h(`Logover 
Unknown option: ${t}`);this.options[t]=e[t]})}info(...e){if(g[this.options.level]<=g.info){let t=E(this.options.timestamp,"info");if(console.info(this.options.info,t,...e),this.options.trace.includes("info")){let o=new h("\x1B[36m[INFO] \x1B[0m");o.stackDepth=this.options.stackTraceDepth,console.log(o.stacks),console.log("")}}}warn(...e){if(g[this.options.level]<=g.warn){let t=E(this.options.timestamp,"warn");if(console.warn(this.options.warn,t,...e),this.options.trace.includes("warn")){let o=new h("\x1B[33m[WARN] \x1B[0m");o.stackDepth=this.options.stackTraceDepth,console.log(o.stacks),console.log("")}}}error(...e){if(g[this.options.level]<=g.error){let t=E(this.options.timestamp,"error");if(console.error(this.options.error,t,...e),this.options.trace.includes("error")){let o=new h("\x1B[31m[ERROR] \x1B[0m");o.stackDepth=this.options.stackTraceDepth,console.log(o.stacks),console.log("")}}}debug(...e){if(g[this.options.level]===g.debug){let t=E(this.options.timestamp,"debug");if(console.debug(this.options.debug,t,...e),this.options.trace.includes("debug")){let o=new h("\x1B[32m[DEBUG] \x1B[0m");o.stackDepth=this.options.stackTraceDepth,console.log(o.stacks),console.log("")}}}set option(e){Object.keys(e).map(t=>{if(!this.options.hasOwnProperty(t))throw new h(`Logover 
Unknown option: ${t}`);this.options[t]=e[t]})}};const v=new ie({level:process.env.LOG_LEVEL||"info"});class ae{constructor(t){B(this,"_codeString");B(this,"_fileName");B(this,"_expressions");this._codeString=t,this._fileName="__nodebug.js",this._expressions=[]}attachDebugger(t,o){const r=this._codeString.slice(0,t),i=this._codeString.slice(t);return this._codeString=r+`
console.log("--NODE_BUG--");debugger;`+i,this._expressions.push(o),this}inspect(){return x(this,null,function*(){yield this._writeCodeToFile();const t=X(`node inspect ${this._fileName}`,{env:F(D({},process.env),{NODE_INSPECT_RESUME_ON_START:"1"})});if(!t.stdout||!t.stderr||!t.stdin)throw new Error("stdout is null");const o=[];let r=!1;t.stdout.on("data",n=>{if(v.debug(n.toString()),n.includes("--NODE_BUG--")&&!n.includes('console.log("--NODE_BUG--");debugger;')&&this._expressions.length){const s=this._expressions.shift();setTimeout(()=>{t.stdin.write(s+`
`),this._expressions.length===0&&(r=!0)},1e3)}if(r){v.debug("Data I want: ",n.toString());const s=n.toString().split(`
debug>`)[0];o.push(s),r=!1,t.stdin.write(`.exit
`)}}),t.stderr.on("data",n=>{v.error(`stderr: ${n}`)}),t.on("close",n=>{v.info(`child process exited with code ${n}`),this._cleanUp()});const i=yield t,l=F(D({},i),{output:o});return yield this._cleanUp(),l})}_writeCodeToFile(){return x(this,null,function*(){yield N.writeFile(this._fileName,this._codeString,"utf-8")})}_cleanUp(){return x(this,null,function*(){yield N.rm(this._fileName)})}}exports.NodeBug=ae;
